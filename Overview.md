The overall system can be broken down in 5 main modules: localization, perception, navigation, control and drive-by-wire. Those modules are themselves made of several parts that run as separate processes. To orchestrate those processes and how they communicate we use [[ROS|http://www.ros.org]].

# Sensors

The main sensors on the car are:
 * **Applanix** which combines the IMU, GPS and encoder, to provide the best estimate of the car's position. As the IMU is of very good quality, we get a very precise displacement information, that we use to compute the **smooth** coordinates (more on that later). As it is connected to the **Trimble** GPS receiver with Omnistar capability, the error on the global position is usually smaller than a meter.
 * **Velodyne**, a 64 beams 360 degrees laser scanner.
 * **Ladybug**, a 360 degrees field of view camera.

There are more sensors, but we are currently not using them.

# Localization

The localization module uses the information from the Applanix to estimate the location and pose of the vehicle.

## Global coordinates

The applanix sensor gives a position estimate in global coordinates (latitude, longitude, altitude, etc.). This estimates is computed from the GPS position combined with IMU readings. It's quite accurate and the error is bounded by the GPS error. However, in case the GPS is not available for a while, the position could jump significantly when the GPS becomes available again.

## Smooth coordinates

When the applanix module is first started, it takes the initial location as origin. From there, is computes the smooth coordinates by integrating the measured velocity given by the applanix sensor. The key properties of the smooth frame are:

* it's drifting with time, and the error is unbounded. It means that after some time, the position of the origin of the smooth frame, plus the current position in the smooth frame, is no longer equal to the global coordinates.
* there is no sudden jump in pose from one measurement to the next, which makes it suitable for frame to frame analysis (point matching, etc.). 

## UTM coordinates and offset

The `localize` module provides the offset between the UTM coordinates of the car and the smooth coordinates, such that UTM = Offset + Smooth. There are 2 localizers. 

 * The simplest, called `fake_localizer` computes this offset by simply substracting the smooth coordinates from the UTM coordinates obtained from the latitude and longitude returned by the applanix. 
 * The other localizer, matches the observation from the velodyne with a map to refine the position estimate and compute the offset. How the map is obtained in the first place, and how the matching is done, is described in J. Levinson's thesis. The result is a localization with an accuracy of about 10cm.

# Perception

The perception module, in its current state, uses only the information from the velodyne. This means that the perception range is of about 50m, and that there is no color information, and compared to a camera it's relatively low resolution.

The velodyne gives about 140,000 points per spin, with a spin every 100ms. The perception module parses those points to find out where are the obstacles, track them and classify them. First points are classified as ground or obstacle (points above the ground), then obstacle points are clustered into blobs. The blobs are tracked using a centroid based multi kalmann filter approach. Each track is then classified as car, pedestrian, bicycle or other. This runs in real time, consuming a fair amount of CPU resources. The detected obstacles are then passed to the navigation module.

# Navigation

The navigation module generates an appropriate trajectory for the car to realize the mission and avoid obstacles while respecting the road regulations. It relies on the definition of the road network [[RNDF|RNDF Specification]], which describes where are the roads, the lanes, the stop signs, the pedestrian crossings, etc. in UTM coordinates. Then the mission is expressed as a set of check points in the RNDF, similar to how you would describe a route as a sequence of roads. 

In the absence of obstacles (or when the perception module is turned off), the planner generates a route that will connect those check points, and follows the centerline, stopping at the stop signs. When obstacles are detected, it will compute a trajectory that avoids the obstacles, or follow them (the car in front for instance), compute priorities at stop intersections, etc.

# Control and drive-by-wire

The controller is in charge of realizing the trajectory generated by the navigation module. It computes the appropriate throttle, break and steering commands and pass them to the car via the drive-by-wire system.